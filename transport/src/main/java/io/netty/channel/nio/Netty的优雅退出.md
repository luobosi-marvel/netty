# Netty 的优雅退出
当应用进程优雅退出时，作为通信框架 Netty 也需要优雅退出，主要原因如下
- 尽快的释放 NIO 线程、句柄等资源
- 如果使用 flush 做批量消息发送，需要将积攒在发送队列中的待发送消息发送完成
- 正在 write 或者 read 的消息，需要继续处理
- 设置在 NioEventLoop 线程调度器中的定时任务，需要执行或者清理

# Netty 的优雅退出总结起来有三大步骤
- 吧 NIO 线程的状态位设置成 ST_SHUTTING_DOWN 转态，不再处理新的消息(不允许再对外发送消息)
- 退出前的预处理操作：把发送队列中尚未发送或者正在发送的消息发送完，把已经到期或者在退出超时之前到期
的定时任务执行完成、把用户注册到 NIO 的线程的退出 Hook 任务执行完成
- 资源的释放操作：所有 Channel 的释放、多路复用的去注册和关闭、所有队列和定时任务的清空取消、最后
是 NIO 线程的退出。


# Netty 优雅退出主要操作和资源对象
### 预处理操作
- 通信队列中尚未发送的消息
- NIO 线程中待处理的定时任务
- 注册到 NIO 线程中的 ShutdownHook 任务
### 资源释放
- 关闭所有的 Channel
- 从 Selector 上去注册
- 清空所有的队列
- NIO 线程退出